# Mobile Release Build Workflow
# Triggers on push to release-x.x.x branches
# Automatically builds APK and creates GitHub release

name: Mobile Release Build

on:
  push:
    branches:
      - "release-*.*.*"

concurrency:
  group: mobile-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================
  # Extract version from branch name
  # ===========================================
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
    steps:
      - name: Extract version from branch
        id: extract
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          VERSION="${BRANCH_NAME#release-}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION"

  # ===========================================
  # Validate Mobile App
  # ===========================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm turbo build --filter=@quizapp/shared

      - name: Lint mobile app
        run: pnpm --filter mobile lint

  # ===========================================
  # Build Android APK
  # ===========================================
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: [prepare, validate]
    outputs:
      build-url: ${{ steps.get-url.outputs.build-url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm turbo build --filter=@quizapp/shared

      - name: Update app version
        working-directory: apps/mobile
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          # Update version in app.json if needed
          echo "Building version: $VERSION"

      - name: Build Android APK
        id: build
        working-directory: apps/mobile
        run: |
          eas build --platform android --profile production --non-interactive --json > build-output.json
          cat build-output.json

      - name: Get build URL
        id: get-url
        working-directory: apps/mobile
        run: |
          # Wait for build to complete
          sleep 10
          BUILD_ID=$(eas build:list --platform android --status finished --limit 1 --json | jq -r '.[0].id')
          BUILD_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl // empty')
          echo "build-url=$BUILD_URL" >> $GITHUB_OUTPUT
          echo "Build URL: $BUILD_URL"

  # ===========================================
  # Create GitHub Release
  # ===========================================
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, build-android]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Download APK
        working-directory: apps/mobile
        run: |
          BUILD_URL="${{ needs.build-android.outputs.build-url }}"
          if [ -n "$BUILD_URL" ]; then
            curl -L -o "QuizApp-v${{ needs.prepare.outputs.version }}.apk" "$BUILD_URL"
          else
            echo "Build URL not available, fetching from EAS..."
            BUILD_ID=$(eas build:list --platform android --status finished --limit 1 --json | jq -r '.[0].id')
            BUILD_URL=$(eas build:view $BUILD_ID --json | jq -r '.artifacts.buildUrl')
            curl -L -o "QuizApp-v${{ needs.prepare.outputs.version }}.apk" "$BUILD_URL"
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Release v${{ needs.prepare.outputs.version }}
          body: |
            ## QuizApp Mobile v${{ needs.prepare.outputs.version }}

            ### Downloads
            - **Android APK**: Download from assets below

            ### Installation
            1. Download the APK file
            2. Enable "Install from unknown sources" in Settings
            3. Open the APK and install

            ---
            *Built automatically from branch `${{ github.ref_name }}`*
          files: |
            apps/mobile/QuizApp-v${{ needs.prepare.outputs.version }}.apk
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # Notify
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, create-release]
    if: always()
    steps:
      - name: Release Status
        run: |
          echo "Release v${{ needs.prepare.outputs.version }} completed"
          echo "Status: ${{ needs.create-release.result }}"
