# Mobile Production Build Workflow
# Creates production builds for release
# Triggered on push to main or release tags

name: Mobile Production Build

on:
  push:
    branches: [main]
    paths:
      - "apps/mobile/**"
      - "packages/shared/**"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      platform:
        description: "Platform to build"
        required: true
        default: "android"
        type: choice
        options:
          - android
          - ios
          - all
      submit:
        description: "Submit to store after build"
        required: false
        default: false
        type: boolean
      profile:
        description: "Build profile"
        required: false
        default: "production"
        type: choice
        options:
          - production
          - preview

concurrency:
  group: mobile-production-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ===========================================
  # Validate before building
  # ===========================================
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm turbo build --filter=@quizapp/shared

      - name: Lint mobile app
        run: pnpm --filter mobile lint

      - name: Typecheck mobile app
        run: pnpm --filter mobile typecheck

  # ===========================================
  # Build Android Production
  # ===========================================
  build-android:
    name: Build Android Production
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'release' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_dispatch' && (inputs.platform == 'android' || inputs.platform == 'all'))
    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm turbo build --filter=@quizapp/shared

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ inputs.profile }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "release" ]; then
            echo "profile=production" >> $GITHUB_OUTPUT
          else
            echo "profile=preview" >> $GITHUB_OUTPUT
          fi

      - name: Build Android
        id: build
        working-directory: apps/mobile
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile ${{ steps.profile.outputs.profile }} --non-interactive --json)
          BUILD_ID=$(echo $BUILD_OUTPUT | jq -r '.[0].id')
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT

      - name: Get build artifacts
        id: artifacts
        working-directory: apps/mobile
        run: |
          BUILD_INFO=$(eas build:view ${{ steps.build.outputs.build-id }} --json)
          BUILD_URL=$(echo $BUILD_INFO | jq -r '.artifacts.buildUrl // empty')
          echo "build-url=$BUILD_URL" >> $GITHUB_OUTPUT

  # ===========================================
  # Build iOS Production
  # ===========================================
  build-ios:
    name: Build iOS Production
    runs-on: ubuntu-latest
    needs: validate
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && (inputs.platform == 'ios' || inputs.platform == 'all'))
    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: pnpm turbo build --filter=@quizapp/shared

      - name: Determine build profile
        id: profile
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "profile=${{ inputs.profile }}" >> $GITHUB_OUTPUT
          else
            echo "profile=production" >> $GITHUB_OUTPUT
          fi

      - name: Build iOS
        id: build
        working-directory: apps/mobile
        run: |
          BUILD_OUTPUT=$(eas build --platform ios --profile ${{ steps.profile.outputs.profile }} --non-interactive --json)
          BUILD_ID=$(echo $BUILD_OUTPUT | jq -r '.[0].id')
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT

  # ===========================================
  # Submit to Google Play Store (Optional)
  # ===========================================
  submit-android:
    name: Submit to Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && inputs.submit == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to Play Store
        working-directory: apps/mobile
        run: |
          eas submit --platform android --id ${{ needs.build-android.outputs.build-id }} --non-interactive
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}

  # ===========================================
  # Submit to App Store (Optional)
  # ===========================================
  submit-ios:
    name: Submit to App Store
    runs-on: ubuntu-latest
    needs: build-ios
    if: |
      github.event_name == 'release' ||
      (github.event_name == 'workflow_dispatch' && inputs.submit == true)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Submit to App Store
        working-directory: apps/mobile
        run: |
          eas submit --platform ios --id ${{ needs.build-ios.outputs.build-id }} --non-interactive
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}

  # ===========================================
  # Create GitHub Release Assets
  # ===========================================
  release-assets:
    name: Upload Release Assets
    runs-on: ubuntu-latest
    needs: [build-android]
    if: github.event_name == 'release'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Download Android build
        working-directory: apps/mobile
        run: |
          BUILD_INFO=$(eas build:view ${{ needs.build-android.outputs.build-id }} --json)
          BUILD_URL=$(echo $BUILD_INFO | jq -r '.artifacts.buildUrl')
          curl -L -o quizapp-${{ github.event.release.tag_name }}.apk "$BUILD_URL"

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: apps/mobile/quizapp-${{ github.event.release.tag_name }}.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================
  # Notify on completion
  # ===========================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: always()
    steps:
      - name: Build Status
        run: |
          echo "Android Build: ${{ needs.build-android.result }}"
          echo "iOS Build: ${{ needs.build-ios.result }}"

      # Optional: Add Slack/Discord notification here
      # - name: Send Slack notification
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "Mobile build completed: Android=${{ needs.build-android.result }}, iOS=${{ needs.build-ios.result }}"
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
